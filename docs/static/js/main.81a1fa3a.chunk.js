(this["webpackJsonptubes-chat"]=this["webpackJsonptubes-chat"]||[]).push([[0],{14:function(e,t,n){e.exports=n(20)},20:function(e,t,n){"use strict";n.r(t);var a=n(0),i=n.n(a),s=n(11),c=n.n(s),o=(n(19),n(3)),r=n(5),l=n(8),u=n(9),d=n(1),h=n(2),m=n(7),f=n(13),v=n(12),_=function(){function e(){Object(d.a)(this,e),this.listeners={}}return Object(h.a)(e,[{key:"addEventListener",value:function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(e in this.listeners)for(var n=this.listeners[e],a=0,i=n.length;a<i;a++)if(n[a]===t)return void n.splice(a,1)}},{key:"dispatchEvent",value:function(e){if(!(e.type in this.listeners))return!0;for(var t=this.listeners[e.type].slice(),n=0,a=t.length;n<a;n++)if(!1===t[n].call(this,e)||e.defaultPrevented)return!1;return!0}}]),e}(),b=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if("object"!==typeof t)throw new Error("can only be an object");var a=t;return n.forEach((function(e){a=a[e]})),new Proxy(a,{get:y(e,t,n),set:p(e,t,n),deleteProperty:p(e,t,n)})},y=function(e,t,n){return function(a,i){return"object"===typeof a[i]&&null!==a[i]?b(e,t,n.slice(0).concat(i)):a[i]}},p=function(e,t,n){return function(a,i,s){if(e&&"function"===typeof e){var c={store:t,keys:n.slice(0).concat(i),old_val:a[i],new_val:s};if(!e(c))return!0}return null==s?delete a[i]:a[i]=s,!0}},E="ts_leadership_elect",g=function(e,t){return Math.floor(Math.random()*(t-e))+e},k=function(){function e(t){Object(d.a)(this,e),this.leader_id=null,this.connected_ids=new Set([]),this.connected_count=0,this.conn=t,t.addEventListener("message",this.onMessage.bind(this))}return Object(h.a)(e,[{key:"onMessage",value:function(e){var t=JSON.parse(e.data);switch(t.action){case"identity":this.onIdentity(t);break;case"connected":this.onConnected(t);break;case"disconnected":this.onDisconnected(t);break;case E:this.onElect(t)}}},{key:"onIdentity",value:function(e){this.connected_count=e.client_count,this.connected_ids.add(e.client_id),1===e.client_count&&this.elect()}},{key:"onConnected",value:function(e){this.connected_count=e.client_count,this.connected_ids.add(e.client_id),this.isLeader&&this.conn.client_id!==e.client_id&&this.sync(e.client_id)}},{key:"onDisconnected",value:function(e){this.connected_count=e.client_count,this.connected_ids.delete(e.client_id),e.client_id===this.leader_id&&(this.leader_id=null,this.connected_ids.values().next().value===this.conn.client_id?this.elect():this.waitForNomination(g(3e3,5e3)))}},{key:"waitForNomination",value:function(e){setTimeout(this.nominate.bind(this),e)}},{key:"nominate",value:function(){null===this.leader_id&&this.elect()}},{key:"sync",value:function(e){this.conn.sendJSONTo(e,{action:E,order:Array.from(this.connected_ids),store:this.conn.data})}},{key:"elect",value:function(){this.leader_id=this.conn.client_id,this.conn.sendJSON({action:E,order:Array.from(this.connected_ids),store:this.conn.data})}},{key:"onElect",value:function(e){null===this.leader_id&&(this.leader_id=e.client_id,this.connected_ids=new Set(e.order),this.conn.data=Object.assign(this.conn.data,e.store))}},{key:"isLeader",get:function(){return null!==this.leader_id&&null!==this.conn.client_id&&this.leader_id===this.conn.client_id}}]),e}(),N=function(e){Object(f.a)(n,e);var t=Object(v.a)(n);function n(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(d.a)(this,n),(a=t.call(this)).client_id=null,a.jwt=null,a.buffer=[],a.onopen=null,a.onclose=null,a.onerror=null,a.onmessage=null,a.onmessage=null,a.onstatechange=null,a._room=e,a.local=i.debug,a.WSClass=i.WSClass||WebSocket,a.leadership=new k(Object(m.a)(a)),a.data=i.initialState,a.state=b(a._onstatechange,i.initialState),i.noconnect||a.connect(),a}return Object(h.a)(n,[{key:"connect",value:function(){this.isConnected&&this.conn.close(),this.conn=new this.WSClass(this.url),this.conn.onopen=this._onopen.bind(this),this.conn.onclose=this._onclose.bind(this),this.conn.onerror=this._onerror.bind(this),this.conn.onmessage=this._onmessage.bind(this)}},{key:"_safeCall",value:function(e,t){return this.dispatchEvent(t)||"function"===typeof e&&e(t)}},{key:"_onopen",value:function(e){var t=this;this.buffer.forEach((function(e){t.send(e)})),this.buffer=[],this._safeCall(this.onopen,e)}},{key:"_onclose",value:function(e){setTimeout(this.connect.bind(this),5e3),this._safeCall(this.onclose,e)}},{key:"_onmessage",value:function(e){var t=JSON.parse(e.data);switch(t.action){case"identity":this.client_id=t.client_id,this.jwt=t.jwt}this._safeCall(this.onmessage,e)}},{key:"_onerror",value:function(e){this._safeCall(this.onerror,e)}},{key:"_onstatechange",value:function(e){var t=new CustomEvent("ts_change",{detail:e});return this._safeCall(this.onstatechange,t)}},{key:"send",value:function(e){this.isConnected?this.conn.send(e):this.buffer.push(e)}},{key:"sendJSON",value:function(e){this.send(JSON.stringify(e))}},{key:"sendJSONTo",value:function(e,t){e!==this.client_id&&("object"===typeof t&&null!=t||(t={payload:t}),t.to=e,this.sendJSON(t))}},{key:"sendJSONToLeader",value:function(e){this.sendJSONTo(this.leadership.leader_id,e)}},{key:"url",get:function(){return(this.local?"ws://localhost:8080/".concat(this.room):"wss://tubes.dev/".concat(this.room))+(this.jwt?"?jwt=".concat(this.jwt):"")}},{key:"room",get:function(){return this._room.replace("wss://tubes.dev/","")}},{key:"isConnected",get:function(){return this.conn&&this.conn.readyState===WebSocket.OPEN}},{key:"isLeader",get:function(){return this.leadership.isLeader}},{key:"clientCount",get:function(){return this.leadership.connected_count}}]),n}(_);var O=function(e){var t=e.conn;return i.a.createElement("form",{onSubmit:function(e){e.preventDefault();var n=e.target.elements.message.value;t.sendJSON({action:"chat_message",text:n}),e.target.reset()}},i.a.createElement("div",{className:"field has-addons"},i.a.createElement("div",{className:"control is-expanded"},i.a.createElement("input",{className:"input",name:"message",type:"text",placeholder:"Type your message"})),i.a.createElement("div",{className:"control"},i.a.createElement("button",{className:"button is-info"},"Send"))))};var j=function(e){var t=e.client_id,n=e.messages,a=e.users,s={me:"right",system:"center",them:"left"},c={me:"is-info",system:"",them:"is-success"};return i.a.createElement("div",{style:{heigth:"100%",width:"100%"}},n.map((function(e,n){var o=function(e){return e.is_system?"system":e.client_id===t?"me":"them"}(e);return i.a.createElement("p",{key:n,style:{padding:".25em",textAlign:s[o],overflowWrap:"normal"}},i.a.createElement("span",{className:"tag is-medium ".concat(c[o])},function(e){var t;return"".concat((null===(t=a[e.client_id])||void 0===t?void 0:t.username)||"anon"," : ")}(e),e.text))})))};var S=function(e){var t=e.connect;return i.a.createElement("form",{onSubmit:function(e){e.preventDefault();var n=e.target.elements.url.value,a=e.target.elements.username.value;t(n,a)}},i.a.createElement("div",{className:"field"},i.a.createElement("label",{className:"label"},"Room"),i.a.createElement("div",{className:"control"},i.a.createElement("input",{className:"input",name:"url",type:"text",placeholder:"wss://tubes.dev/F3A00E",value:"wss://tubes.dev/F3A00E",onChange:function(){return!0}}))),i.a.createElement("div",{className:"field"},i.a.createElement("label",{className:"label"},"Username"),i.a.createElement("div",{className:"control"},i.a.createElement("input",{className:"input",name:"username",type:"text",placeholder:"username"}))),i.a.createElement("div",{className:"field"},i.a.createElement("div",{className:"control"},i.a.createElement("button",{className:"button is-link"},"Connect"))))};var w=function(){var e=Object(a.useState)(null),t=Object(u.a)(e,2),n=t[0],s=t[1],c=Object(a.useState)([]),d=Object(u.a)(c,2),h=d[0],m=d[1],f=Object(a.useState)({}),v=Object(u.a)(f,2),_=v[0],b=v[1];return i.a.createElement("section",{className:"hero is-fullheight"},i.a.createElement("div",{className:"hero-head"},i.a.createElement("header",{className:"hero is-primary is-bold"},i.a.createElement("div",{className:"hero-body"},i.a.createElement("div",{className:"container"},i.a.createElement("p",{className:"title"},"Messages through the tubes"))))),i.a.createElement("div",{className:"hero-body"},n?i.a.createElement(j,{client_id:n.client_id,messages:h,users:_}):i.a.createElement(S,{connect:function(e,t){var n=new N(e);n.addEventListener("open",(function(e){n.sendJSON({action:"username",username:t})})),n.addEventListener("message",(function(e){var a=JSON.parse(e.data);switch(a.action){case"connected":n.sendJSONTo(a.client_id,{action:"update_username",username:t});break;case"disconnected":m((function(e){return[].concat(Object(l.a)(e),[{is_system:!0,client_id:a.client_id,text:"disconnected"}])}));break;case"chat_message":m((function(e){return[].concat(Object(l.a)(e),[{client_id:a.client_id,text:a.text}])}));break;case"username":m((function(e){return[].concat(Object(l.a)(e),[{is_system:!0,client_id:a.client_id,text:"connected"}])})),b((function(e){return Object(r.a)(Object(r.a)({},e),{},Object(o.a)({},a.client_id,{username:a.username}))}));break;case"update_username":b((function(e){return Object(r.a)(Object(r.a)({},e),{},Object(o.a)({},a.client_id,{username:a.username}))}))}})),s(n)}})),i.a.createElement("div",{className:"hero-foot"},i.a.createElement("footer",{className:"section is-small"},n?i.a.createElement(O,{conn:n}):"")))};c.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(w,null)),document.getElementById("root"))}},[[14,1,2]]]);
//# sourceMappingURL=main.81a1fa3a.chunk.js.map